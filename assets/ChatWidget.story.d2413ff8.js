import{r as d,a as L,j as D}from"./jsx-runtime.aaeee5b9.js";import{r as V}from"./index.fa6d005c.js";import{c as W,C,K as z,U,o as R,S as M}from"./index.91d0c9af.js";import"./index.981d9313.js";import{B as x}from"./index.c9aa1865.js";import"./index.0715aa1f.js";import"./index.f560bd7a.js";import"./index.07a3552e.js";import{c as v}from"./index.aca7c908.js";import"./index.1a5a5058.js";import"./index.291d94fb.js";import"./index.c4ad23c9.js";import{L as k}from"./index.50785aec.js";import"./index.5abf3150.js";import"./index.d8a4d1a2.js";import"./index.6831c9c4.js";import"./index.515ee6a1.js";import{c as H,s as Y}from"./theme.4198e17a.js";import"./iframe.dd754a32.js";import"./variants.e2f4ea0b.js";import"./top-caret.e7bdc702.js";const j=n=>({type:"intent",payload:n});class P{constructor(t){var a,r;if(this.options=t,this.fetch=(r=t.fetchPonyfill)!=null?r:(a=globalThis.fetch)==null?void 0:a.bind(globalThis),!this.fetch)throw new TypeError("fetch implementation was not provided and a global fetch was not available")}async send(t,a={}){var o,p;const r=new URL(t,this.options.url);a.params&&(r.search=a.params.toString());const i=await this.fetch(r,{method:(o=a.method)!=null?o:"GET",body:a.body?JSON.stringify(a.body):void 0,headers:{"content-type":"application/json",...(p=a.headers)!=null?p:{}}}),l=await i.json().catch(()=>null);if(!i.ok)throw W(i.status,i.statusText,l);return l}async interact(t){return this.send(`state/${t.versionID}/user/${t.sessionID}/interact`,{method:"POST",body:{action:t.action,config:t.config},headers:{authorization:this.options.authorization},params:new URLSearchParams({verbose:"true"})})}}class N{constructor(t={}){var a;this.traces=[],this.registerTraces((a=t.traces)!=null?a:[])}registerTrace(t){return this.traces.push(t),this}registerTraces(t){return t.forEach(a=>this.registerTrace(a)),this}async processTrace(t,a,r){const i={request:a,state:r.state,context:t};for(const l of r.trace){const o=this.traces.find(p=>p.canHandle(l));o&&(i.context=await o.handle(i,l))}return i.context}}class B{constructor(t){this.runtime=new P(t),this.trace=new N(t)}registerStep(t){return this.trace.registerTrace(t),this}async interact(t,a){const r=await this.runtime.interact(a);return this.trace.processTrace(t,a,r)}intent(t){return this.interact(t.context,{action:j(t.payload),sessionID:t.sessionID})}}const _=n=>t=>typeof t=="function"?{canHandle:a=>a.type===n,handle:t}:t,F=_("choice"),G=_("text"),K=_("visual");var T=(n=>(n.USER="user",n.SYSTEM="system",n))(T||{});const J="https://general-runtime.voiceflow.com",q=()=>({messages:[]}),Q=({url:n=J,versionID:t,...a})=>{const[r,i]=d.exports.useState([]),l=d.exports.useMemo(()=>v(),[]),o=d.exports.useMemo(()=>new B({...a,url:n}),[a.authorization]),p=async e=>{const s=await o.interact(q(),{versionID:t,sessionID:l,action:e});i(c=>[...c,{id:v(),type:T.SYSTEM,timestamp:new Date,...s}])},u=async(e,s)=>{i(c=>[...c,{id:v(),type:T.USER,message:e,timestamp:new Date}]),await p(s)};o.registerStep(G(({context:e},{payload:{message:s}})=>(e.messages.push({type:"text",text:s}),e))),o.registerStep(K(({context:e},{payload:{image:s}})=>(e.messages.push({type:"image",url:s}),e))),o.registerStep(F(({context:e},{payload:{buttons:s}})=>(e.actions=s.map(({name:c,request:f})=>({label:c,onClick:()=>u(c,f)})),e))),o.registerStep({canHandle:({type:e})=>e==="cardV2",handle:({context:e},{payload:{title:s,imageUrl:c,description:f,buttons:g}})=>(e.messages.push({type:"card",title:s,description:f.text,image:c,actions:g.map(({name:h,request:m})=>({label:h,onClick:()=>u(h,m)}))}),e)}),o.registerStep({canHandle:({type:e})=>e==="carousel",handle:({context:e},{payload:{cards:s}})=>(e.messages.push({type:"carousel",cards:s.map(({title:c,description:f,imageUrl:g,buttons:h})=>({title:c,description:f.text,image:g,actions:h.map(({name:m,request:S})=>({label:m,onClick:()=>u(m,S)}))}))}),e)});const w=()=>i([]);return{turns:r,reset:w,launch:async()=>{r.length&&w(),await p({type:"launch",payload:null})},reply:async e=>u(e,{type:"text",payload:e})}},X=800,A={opacity:0,transform:"translateY(100%)",transition:H(["transform","opacity"],300)},I={opacity:1,transform:"translateY(0%)"},$=Y("div",{position:"fixed",top:0,bottom:0,left:0,right:0,zIndex:10,"-webkit-font-smoothing":"antialiased","-moz-osx-font-smoothing":"grayscale",[`& > ${x.Container}`]:{...A,color:"$white"},[`& > ${C.Container}`]:{...A,height:X},[`& ${C.Dialog}`]:{flex:1},[`& ${k}`]:{margin:"auto"},[`
    & > ${x.Container},
    & > ${C.Container}
  `]:{position:"absolute",right:"$6",bottom:"$6"},variants:{withChat:{true:{[`& > ${C.Container}`]:{...I}},false:{[`& > ${x.Container}`]:{...I}}}}}),Z=2e3,E=({assistant:n,versionID:t,authorization:a,messageDelay:r=Z})=>{const[i,l]=d.exports.useState(!1),[o,p]=d.exports.useState(!1),[u,w]=d.exports.useState(null),y=Q({versionID:t,authorization:a}),b=d.exports.useRef({}),e=()=>l(!1),s=async()=>{w({startTime:new Date}),p(!1),await y.launch()},c=async()=>{l(!0),u||await s()},f=()=>{e(),p(!0)},g=h=>()=>{b.current[h]=!0};return V.exports.createPortal(L($,{withChat:i,children:[D(x,{svg:"launch",onClick:c}),D(C,{title:n.name,description:n.description,image:n.image,startTime:u==null?void 0:u.startTime,hasEnded:o,isLoading:!y.turns.length,onStart:s,onEnd:f,onSend:y.reply,onMinimize:e,children:y.turns.map(h=>z(h).with({type:T.USER},({id:m,...S})=>d.exports.createElement(U,{...R(S,["type"]),key:m})).with({type:T.SYSTEM},({id:m,...S})=>d.exports.createElement(M,{...R(S,["type"]),image:n.image,isLive:!b.current[m],messageDelay:r,onAnimationEnd:g(m),key:m})).exhaustive())})]}),document.body)},O=Object.assign(E,{Container:$});try{E.displayName="ChatWidget",E.__docgenInfo={description:"",displayName:"ChatWidget",props:{assistant:{defaultValue:null,description:"",name:"assistant",required:!0,type:{name:"{ name: string; description: string; image: string; }"}},messageDelay:{defaultValue:{value:"2000"},description:"",name:"messageDelay",required:!1,type:{name:"number"}},versionID:{defaultValue:null,description:"",name:"versionID",required:!0,type:{name:"string"}},authorization:{defaultValue:null,description:"",name:"authorization",required:!0,type:{name:"string"}},fetchPonyfill:{defaultValue:null,description:"A ponyfill to use for `fetch()`.\nDefaults to the global `fetch()`.",name:"fetchPonyfill",required:!1,type:{name:"FetchFn"}},traces:{defaultValue:null,description:"",name:"traces",required:!1,type:{name:"TraceDeclaration<RuntimeContext, any>[]"}}}},typeof STORYBOOK_REACT_CLASSES<"u"&&(STORYBOOK_REACT_CLASSES["src/views/ChatWidget/index.tsx#ChatWidget"]={docgenInfo:E.__docgenInfo,name:"ChatWidget",path:"src/views/ChatWidget/index.tsx#ChatWidget"})}catch{}const Et={title:"Views/ChatWidget",component:O,args:{versionID:"",authorization:"",assistant:{name:"Assistant Name",image:"https://source.unsplash.com/random/72x72",description:"Voiceflow's virtual assistant is here to help."}}},tt=n=>D(O,{...n}),et=tt.bind({});et.args={};export{et as Default,Et as default};
//# sourceMappingURL=ChatWidget.story.d2413ff8.js.map
